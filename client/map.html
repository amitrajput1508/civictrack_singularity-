<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CivicTrack Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body, html {
      height: 100%;
      margin: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 90vh;
      width: 100%;
    }
    .filters {
      padding: 10px;
      background: #f2f2f2;
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
    }
    select {
      padding: 5px;
    }
    .popup-img {
      max-width: 100px;
      margin-top: 5px;
      border-radius: 8px;
    }
  </style>
</head>
<body>

  <!-- 🔍 Filter Controls -->
  <div class="filters">
    <label>Status:</label>
    <select id="statusFilter">
      <option value="">All</option>
      <option value="Reported">Reported</option>
      <option value="In Progress">In Progress</option>
      <option value="Resolved">Resolved</option>
    </select>

    <label>Category:</label>
    <select id="categoryFilter">
      <option value="">All</option>
      <option value="Roads">Roads</option>
      <option value="Lighting">Lighting</option>
      <option value="Water Supply">Water Supply</option>
      <option value="Cleanliness">Cleanliness</option>
      <option value="Public Safety">Public Safety</option>
      <option value="Obstructions">Obstructions</option>
    </select>

    <label>Distance:</label>
    <select id="distanceFilter">
      <option value="">All</option>
      <option value="1">Within 1 km</option>
      <option value="3">Within 3 km</option>
      <option value="5">Within 5 km</option>
    </select>
  </div>

  <!-- 🗺️ Map -->
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([28.6139, 77.2090], 12); // Default to Delhi

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let userLocation = null;
    let allMarkers = [];

    // 📌 Color based on status
    function getMarkerColor(status) {
      switch (status) {
        case 'Reported': return 'gray';
        case 'In Progress': return 'orange';
        case 'Resolved': return 'green';
        default: return 'blue';
      }
    }

    function clearMarkers() {
      allMarkers.forEach(marker => map.removeLayer(marker));
      allMarkers = [];
    }

    function addMarker(issue) {
      if (!issue.location || !issue.location.coordinates) return;

      const [lng, lat] = issue.location.coordinates;

      const marker = L.circleMarker([lat, lng], {
        radius: 8,
        color: getMarkerColor(issue.status),
        fillColor: getMarkerColor(issue.status),
        fillOpacity: 0.9
      });

      let popup = `
        <strong>${issue.title}</strong><br>
        <em>${issue.category}</em><br>
        ${issue.description}<br>
      `;

      if (issue.photo?.length > 0) {
        popup += `<img src="http://localhost:8000/${issue.photo[0]}" class="popup-img">`;
      }

      marker.bindPopup(popup);
      marker.addTo(map);
      allMarkers.push(marker);
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6371; // Radius of the earth in km
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a =
        Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);

      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c; // Distance in km
    }

    async function loadIssues() {
      const status = document.getElementById('statusFilter').value;
      const category = document.getElementById('categoryFilter').value;
      const distance = parseFloat(document.getElementById('distanceFilter').value);

      const res = await fetch('http://localhost:8000/api/issues');
      const issues = await res.json();

      clearMarkers();

      issues.forEach(issue => {
        const [lng, lat] = issue.location?.coordinates || [];
        if (!lat || !lng) return;

        // ✅ Apply Filters
        if (status && issue.status !== status) return;
        if (category && issue.category !== category) return;

        if (userLocation && distance) {
          const d = calculateDistance(userLocation.lat, userLocation.lng, lat, lng);
          if (d > distance) return;
        }

        addMarker(issue);
      });
    }

    // 📍 Get user's location
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          userLocation = {
            lat: pos.coords.latitude,
            lng: pos.coords.longitude
          };
          map.setView([userLocation.lat, userLocation.lng], 14);
          L.marker([userLocation.lat, userLocation.lng])
            .addTo(map)
            .bindPopup("📍 You are here")
            .openPopup();
          loadIssues();
        },
        (err) => {
          console.warn('Geolocation denied or failed:', err.message);
          loadIssues(); // Still show without location
        }
      );
    } else {
      loadIssues(); // Fallback
    }

    document.getElementById('statusFilter').addEventListener('change', loadIssues);
    document.getElementById('categoryFilter').addEventListener('change', loadIssues);
    document.getElementById('distanceFilter').addEventListener('change', loadIssues);
  </script>

</body>
</html>
